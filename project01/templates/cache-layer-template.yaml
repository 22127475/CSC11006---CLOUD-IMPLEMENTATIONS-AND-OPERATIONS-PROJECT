AWSTemplateFormatVersion: '2010-09-09'
Description: Cache layer template for Project 01 (ElastiCache Valkey Cluster, Subnet Group)

Resources:
  # Subnet Group for ElastiCache Cluster
  CacheSubnetGroup:
    Type: AWS::ElastiCache::SubnetGroup
    Properties:
      Description: "Subnet group for the e-commerce cache, using private subnets."
      SubnetIds:
        - !ImportValue Project01-Private-Subnet-1a
        - !ImportValue Project01-Private-Subnet-1b
      Tags:
        - Key: Name
          Value: Project01-Cache-Subnet-Group

  # ElastiCache Cluster
  ElastiCacheCluster:
    Type: AWS::ElastiCache::ReplicationGroup
    Properties:
      ReplicationGroupDescription: "Valkey cache for e-commerce application"
      Engine: valkey
      EngineVersion: "8.0"
      CacheNodeType: "cache.t3.micro"
      CacheSubnetGroupName: !Ref CacheSubnetGroup
      SecurityGroupIds:
        - !ImportValue Project01-Cache-Tier-SG-ID
      ClusterMode: "disabled"
      NumNodeGroups: 1
      ReplicasPerNodeGroup: 0
      AutomaticFailoverEnabled: false
      MultiAZEnabled: false
      CacheParameterGroupName: "default.valkey8"
      TransitEncryptionEnabled: false
      Tags:
        - Key: Name
          Value: Project01-ElastiCache-Cluster

Outputs:
  ElastiCacheClusterId:
    Description: "The ID of the ElastiCache cluster"
    Value: !Ref ElastiCacheCluster
    Export:
      Name: Project01-ElastiCache-Cluster-Id

  CacheEndpointAddress:
    Description: "The Primary Endpoint of the ElastiCache Valkey cluster"
    Value: !GetAtt ElastiCacheCluster.PrimaryEndPoint.Address
    Export:
      Name: Project01-Cache-EndpointAddress

  CacheEndpointPort:
    Description: "The Port of the ElastiCache Valkey cluster"
    Value: !GetAtt ElastiCacheCluster.PrimaryEndPoint.Port
    Export:
      Name: Project01-Cache-EndpointPort
