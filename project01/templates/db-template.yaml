AWSTemplateFormatVersion: "2010-09-09"
Description: RDS PostgreSQL Multi-AZ

Resources:
  # EC2 to DB Security Group
  EC2SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: SG for EC2 to access DB
      VpcId:
        Fn::ImportValue: Project01-VPC-ID
      Tags:
        - Key: Name
          Value: Project01-EC2-DB

  # Aurora to EC2 Security Group
  DBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: SG for DB allowing traffic from EC2 SG
      VpcId:
        Fn::ImportValue: Project01-VPC-ID
      Tags:
        - Key: Name
          Value: Project01-DB-EC2
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          SourceSecurityGroupId: !Ref EC2SecurityGroup

  # Subnet group for Aurora
  DBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Subnet group for Aurora PostgreSQL
      SubnetIds:
        - Fn::ImportValue: Project01-Private-Subnet-1a
        - Fn::ImportValue: Project01-Private-Subnet-1b
      Tags:
        - Key: Name
          Value: Project01-DB-Subnet-Group

  # Secrets Manager for DB
  DBSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: Project01-DB-Secret
      Description: Credentials for RDS PostgreSQL and Proxy
      SecretString: !Sub |
        {
          "username": "prj01",
          "password": "From1to10"
        }
      Tags:
        - Key: Name
          Value: Project01-DB-Secret

  AuroraCluster:
    Type: AWS::RDS::DBCluster
    Properties:
      DBClusterIdentifier: project01-aurora-cluster
      Engine: aurora-postgresql
      MasterUsername:
        Fn::Sub: "{{resolve:secretsmanager:${DBSecret}:SecretString:username}}"
      MasterUserPassword:
        Fn::Sub: "{{resolve:secretsmanager:${DBSecret}:SecretString:password}}"
      DatabaseName: coffee
      DBSubnetGroupName: !Ref DBSubnetGroup
      Port: 5432
      VpcSecurityGroupIds:
        - !Ref DBSecurityGroup
      BackupRetentionPeriod: 7
      DeletionProtection: false
      Tags:
        - Key: Name
          Value: Project01-Aurora-Cluster

  AuroraInstance:
    Type: AWS::RDS::DBInstance
    Properties:
      DBInstanceIdentifier: Project01-DB-Instance
      DBClusterIdentifier: !Ref AuroraCluster
      DBInstanceClass: db.t3.medium
      Engine: aurora-postgresql
      PubliclyAccessible: false
      Tags:
        - Key: Name
          Value: Project01-Aurora-Instance
  AuroraReplica:
    Type: AWS::RDS::DBInstance
    Properties:
      DBInstanceIdentifier: Project01-DB-Replica
      DBClusterIdentifier: !Ref AuroraCluster
      DBInstanceClass: db.t3.medium
      Engine: aurora-postgresql
      PubliclyAccessible: false
      Tags:
        - Key: Name
          Value: Project01-DB-Replica

Outputs:
  EC2SecurityGroupId:
    Description: SG to attach to EC2/ASG to allow DB access
    Value: !Ref EC2SecurityGroup
    Export:
      Name: Project01-EC2-DB-SG-ID
  DBSecurityGroupId:
    Description: SG for db allowing connections from EC2 SG
    Value: !Ref DBSecurityGroup
    Export:
      Name: Project01-DB-EC2-SG-ID
  DBSecretArn:
    Description: ARN of the DB secret
    Value: !Ref DBSecret
    Export:
      Name: Project01-DB-Secret-Arn
  DBSubnetGroupName:
    Description: Name of the DB subnet group
    Value: !Ref DBSubnetGroup
    Export:
      Name: Project01-DB-Subnet-Group-Name
  AuroraClusterId:
    Description: ID of the Aurora cluster
    Value: !Ref AuroraCluster
    Export:
      Name: Project01-Aurora-Cluster-Id
  AuroraClusterEndpoint:
    Description: Endpoint of the Aurora cluster
    Value: !GetAtt AuroraCluster.Endpoint.Address
    Export:
      Name: Project01-Aurora-Cluster-Endpoint
  AuroraReplicaId:
    Description: ID of the Aurora read replica
    Value: !Ref AuroraReplica
    Export:
      Name: Project01-Aurora-Replica-Id
  AuroraReplicaEndpoint:
    Description: Endpoint of the Aurora read replica
    Value: !GetAtt AuroraReplica.Endpoint.Address
    Export:
      Name: Project01-Aurora-Replica-Endpoint
